apiVersion: apps/v1
kind: Deployment
metadata:
  name: store-container
spec:
  replicas: 2
  selector:
    matchLabels:
      app: store-container
  template:
    metadata:
      labels:
        app: store-container

    spec:
      volumes:
        - name: wallet-volume
          secret:
            secretName: wallet-secret
      containers:
      - name: store-container
        image: us-chicago-1.ocir.io/axswp1b7lgyy/springbootstore/store
        imagePullPolicy: Always
        volumeMounts:
          - name: wallet-volume
            mountPath: /app/wallet 
        env:
        # --- Base de datos Oracle ---
        - name: SPRING_DATASOURCE_URL
          value: jdbc:oracle:thin:@microservicesdb_medium?TNS_ADMIN=/app/wallet
        - name: SPRING_DATASOURCE_USERNAME
          value: ITEMS
        - name: SPRING_DATASOURCE_PASSWORD
          value: Mundialmente1$
        - name: SPRING_DATASOURCE_DRIVER_CLASS_NAME
          value: oracle.jdbc.OracleDriver
         # --- Redis Cloud ---
        - name: SPRING_SESSION_STORE_TYPE
          value: redis
        - name: SPRING_REDIS_HOST
          value: redis-13700.c328.europe-west3-1.gce.redns.redis-cloud.com
        - name: SPRING_REDIS_PORT
          value: "13700"
        - name: SPRING_REDIS_PASSWORD
          value: iRBz0IvyeSm0avlugvSwBQIpwtgqKJTk
        - name: SPRING_REDIS_SSL
          value: "true"
        - name: SPRING_SESSION_REDIS_ENABLE_KEYSPACE_EVENTS
          value: "false"
        - name: SPRING_SESSION_REDIS_NAMESPACE
          value: app:session

        # --- Server ---
        - name: SERVER_PORT
          value: "8443"
        - name: SERVER_SSL_ENABLED
          value: "false"

        ports:
        - containerPort: 8443
      imagePullSecrets:
      - name: ocirsecret
---
apiVersion: v1
kind: Service
metadata:
  name: store-service
spec:
  selector:
    app: store-container
  ports:
    - port: 8443
      targetPort: 8443
  type: ClusterIP
